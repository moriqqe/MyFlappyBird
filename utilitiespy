import pygame
import csv
import os
from classes import Bird, Pipe

def draw_text(text, font, color, surface, x, y):
    textobj = font.render(text, True, color)
    textrect = textobj.get_rect()
    textrect.topleft = (x, y)
    surface.blit(textobj, textrect)

def measure_text_width(text, font):
    textobj = font.render(text, True, (0, 0, 0))
    return textobj.get_width()

def nickname_input(screen, font, large_font):
    input_active = True
    nickname = ""
    while input_active:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                exit()
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_RETURN:
                    input_active = False
                elif event.key == pygame.K_BACKSPACE:
                    nickname = nickname[:-1]
                else:
                    nickname += event.unicode
        screen.fill((0, 0, 0))
        draw_text('Enter your nickname:', font, (255, 255, 255), screen, 150, 350)
        nickname_width = measure_text_width(nickname, large_font)
        draw_text(nickname, large_font, (255, 255, 255), screen, 300 - nickname_width / 2, 400)
        pygame.display.update()
    return nickname

def update_leaderboard(nickname, score):
    file_path = os.path.join(os.getcwd(), 'leaderboard.csv')
    file_exist = os.path.isfile(file_path)
    leaderboard = []
    found = False
    if file_exist:
        with open(file_path, mode='r', newline='') as file:
            reader = csv.reader(file)
            next(reader)  # Skip header
            for row in reader:
                if row[0] == nickname:
                    best_score = max(int(row[2]), score)
                    leaderboard.append([nickname, score, best_score])
                    found = True
                else:
                    leaderboard.append(row)
    else:
        print("Leaderboard file does not exist. It will be created.")
    if not found:
        leaderboard.append([nickname, score, score])
    with open(file_path, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(['Nickname', 'Last Score', 'Best Score'])
        writer.writerows(leaderboard)
        print("Leaderboard updated.")
